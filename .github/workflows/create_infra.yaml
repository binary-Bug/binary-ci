# - Takes env_name (used for both resource_group_name and name_prefix) and run_apply as inputs
# - Installs Terraform, logs into Azure, runs import, init, plan, and optionally apply
# - Each job logs into Azure to ensure env vars are available

run-name: Creating infrastructure - ${{ github.event.inputs.rg_name }}
name: "☁️ Create Infrastructure"

on:
  workflow_dispatch:
    inputs:
      rg_name:
        description: "Resource group name"
        required: true
        default: "eat-career"
        type: string

      name_prefix:
        description: "Prefix name (used for adding prefix to resources)"
        required: true
        default: "eat"
        type: string

      run_apply:
        description: "Run terraform apply?"
        required: false
        default: false
        type: boolean

concurrency:
  group: create-infra
  cancel-in-progress: true

jobs:
  import:
    name: "Terraform Import"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra
    env:
      TF_VAR_resource_group_name: ${{ inputs.rg_name }}
      TF_VAR_name_prefix: ${{ inputs.name_prefix }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZ_CREDS }}

      - name: Terraform Init
        run: terraform init

      - name: Check Resource Group Existence
        id: check_rg
        run: |
          if az group show --name "${{ inputs.rg_name }}" --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"; then
            echo "rg_exists=true" >> $GITHUB_ENV
          else
            echo "rg_exists=false" >> $GITHUB_ENV
          fi

      - name: Terraform Import Resource Group
        if: env.rg_exists == 'true'
        run: |
          terraform import azurerm_resource_group.main "/subscriptions/${{ env.ARM_SUBSCRIPTION_ID }}/resourceGroups/${{ inputs.rg_name }}"
          echo "Terraform import succeeded."

      - name: Create Empty tfstate if Resource Group Not Found
        if: env.rg_exists == 'false'
        run: |
          echo "Resource group not found. Creating empty tfstate file."
          echo '{"version":4,"resources":[]}' > terraform.tfstate

      - name: Upload Terraform State
        uses: actions/upload-artifact@v4
        with:
          name: tfstate-${{ inputs.rg_name }}
          path: infra/terraform.tfstate*

  plan:
    name: "Terraform Init & Plan"
    runs-on: ubuntu-latest
    needs: import
    defaults:
      run:
        working-directory: infra
    env:
      TF_VAR_resource_group_name: ${{ inputs.rg_name }}
      TF_VAR_name_prefix: ${{ inputs.name_prefix }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Terraform State
        uses: actions/download-artifact@v4
        with:
          name: tfstate-${{ inputs.rg_name }}
          path: infra

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -var "resource_group_name=${{ inputs.rg_name }}" -var "name_prefix=${{ inputs.name_prefix }}" | tee plan.txt

      - name: Upload Terraform Plan Output
        uses: actions/upload-artifact@v4
        with:
          name: plan-output
          path: infra/plan.txt

  plan-summary:
    name: "Terraform Plan Output"
    runs-on: ubuntu-latest
    needs: plan
    steps:
      - name: Download Terraform Plan Output
        uses: actions/download-artifact@v4
        with:
          name: plan-output
          path: infra

      - name: Add Terraform Plan to Job Summary
        run: |
          perl -pe 's/\e\[[0-9;]*[mK]//g' infra/plan.txt > infra/clean_plan.txt

          echo '' >> $GITHUB_STEP_SUMMARY

          awk '/^Plan: [0-9]+ to add, [0-9]+ to change, [0-9]+ to destroy\./ {print_flag=1}print_flag && !/\(known after apply\)/ {print}' infra/clean_plan.txt >> infra/summary.txt

          sed -E 's/^Plan: ([0-9]+) to add, ([0-9]+) to change, ([0-9]+) to destroy\./### 🚀 **Plan**: \1 to add 🛠️, \2 to change 🔄, \3 to destroy 💣/; s/^Changes to Outputs:/### 🔧 Changes to Outputs:/; s/^  \+ ([a-zA-Z0-9_]+)\s+=\s+"(.*)"/- **\1**: `\2`/; s/^  \+ ([a-zA-Z0-9_]+)\s+=\s+\[$/- **\1**:/; s/^  \+ ([a-zA-Z0-9_]+)\s+=\s+\{/- **\1**:/; s/^    \+ ([a-zA-Z0-9_]+)\s+=\s+"(.*)"/  - **\1**: `\2`/; s/^    \+ ([a-zA-Z0-9_]+)\s+=\s+(.*)/  - **\1**: `\2`/; s/^      \+ ([a-zA-Z0-9_]+)\s+=\s+"(.*)"/  - **\1**: `\2`/; s/^      \+ ([a-zA-Z0-9_]+)\s+=\s+(.*)/  - **\1**: `\2`/; s/^    \+ "(.*)"/  - `\1`/; s/^      \+ \{//; s/^      \+ \}//; s/^\s*\{//; s/^\s*\}//; s/^\s*,\s*$//; s/^\s*\]$//' infra/summary.txt >> infra/formatted_summary.txt

          sed -E 's/^[[:space:]]*\+ ([a-zA-Z0-9_]+) = "(.*)"/  - **\1**: `\2`/; s/^[[:space:]]*\+ ([a-zA-Z0-9_]+) = ([^"].*)/  - **\1**: `\2`/; s/^[[:space:]]*\+ ?\{.*//; s/^[[:space:]]*\+ ?\}.*//; /^$/d' infra/formatted_summary.txt >> infra/cleaned_summary.txt

          sed '/^[─-]\{10,\}$/,/^$/d' infra/cleaned_summary.txt >> infra/final_summary.txt

          cat infra/final_summary.txt >> $GITHUB_STEP_SUMMARY

  apply:
    name: "Terraform Apply"
    runs-on: ubuntu-latest
    needs: plan
    if: ${{ always() && github.event.inputs.run_apply == 'true' }}
    defaults:
      run:
        working-directory: infra
    env:
      TF_VAR_resource_group_name: ${{ inputs.rg_name }}
      TF_VAR_name_prefix: ${{ inputs.name_prefix }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Terraform State
        uses: actions/download-artifact@v4
        with:
          name: tfstate-${{ inputs.rg_name }}
          path: infra

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -var "resource_group_name=${{ inputs.rg_name }}" -var "name_prefix=${{ inputs.name_prefix }}" -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

  cleanup:
    runs-on: ubuntu-latest
    needs:
      - import
      - plan
      - plan-summary
      - apply
    if: always() # ✅ runs even if any job fails
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: "*"
          failOnError: false
