name: "ðŸš€ Deploy Artifact"
run-name: "Deploy Artifact for ${{ github.event.inputs.component }}"

on:
  workflow_dispatch:
    inputs:
      component:
        description: "Select component"
        required: true
        type: choice
        options:
          - piggy-ui
          - piggy-api
          - piggy-db
      version:
        description: "Version to deploy (e.g., 0.8.17)"
        required: true
        type: string

jobs:
  setup-deployment:
    name: 'Setup Deployment'
    runs-on: ubuntu-latest
    outputs:
      artifact_name: ${{ steps.build_name.outputs.artifact_name }}
      run_id: ${{ steps.find_run.outputs.run_id }}
    steps:
      - name: Build artifact name
        id: build_name
        run: |
          ARTIFACT_NAME="${{ github.event.inputs.component }}-v${{ github.event.inputs.version }}"
          echo "The artifact to download is $ARTIFACT_NAME"
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
      - name: Find workflow run id for artifact
        id: find_run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ARTIFACT_NAME="${{ steps.build_name.outputs.artifact_name }}"
          RUN_ID=$(gh api repos/${{ github.repository }}/actions/artifacts \
            --jq ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .workflow_run.id" | head -n 1)
          if [ -z "$RUN_ID" ]; then
            echo "No workflow run found for artifact $ARTIFACT_NAME" >&2
            exit 1
          fi
          echo "Found run id: $RUN_ID"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

  download-artifact:
    name: 'Download Artifact'
    needs: setup-deployment
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact from github storage
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup-deployment.outputs.artifact_name }}
          path: ./artifact
          run-id: ${{ needs.setup-deployment.outputs.run_id }}
      - name: list artifacts
        run: |
          echo "Listing downloaded artifacts:"
          ls -l ./artifact